- copy_kickstart_file_to_http_directory:
  - exec_local: cp $${base_kickstart_path} $${http_directory}/ks.cfg

- customize_kickstart:
  - exec_local: sed -i s'|rootpw\(.*\)|rootpw $${root_password}|'g $${http_directory}/ks.cfg
  - exec_local: sed -i s'|url --url\(.*\)|url --url=$${mirror_url}|'g $${http_directory}/ks.cfg

- modify_grub.cfg:
  - test:
    - exec_local: test "$${arch}" == "aarch64"
    - group:
      - check_cmd_local: xorriso
      - exec_local: export SOURCE_ISO=/tmp/source.iso
      - exec_local: mv $${qemu_iso_path} $SOURCE_ISO
      - exec_local: echo "Modifying grub.cfg."
      - exec_local: osirrox -indev $SOURCE_ISO -extract /EFI/BOOT/grub.cfg grub.cfg
      - exec_local: sed -i "s/set default=\"1\"/set default=\"0\"/g" grub.cfg
      - exec_local: sed -i "s/set timeout=60/set timeout=10/g" grub.cfg
      - exec_local: sed -i "s|vmlinuz|vmlinuz inst.ks=http://$${local_ip}:$HTTP_PORT/ks.cfg|g" grub.cfg
      - exec_local: xorriso -indev $SOURCE_ISO -outdev /tmp/out.iso -compliance no_emul_toc -map grub.cfg /EFI/BOOT/grub.cfg -boot_image any replay
      - exec_local: mv /tmp/out.iso $${qemu_iso_path}
