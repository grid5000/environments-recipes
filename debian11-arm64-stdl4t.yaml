#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: Debian bullseye (11) arm64 std Grid'5000 environment
#
#==============================================================================
---
extend: ./debian11-arm64-common.yaml

global:
  # Grid'5000 environment variant
  g5k_variant: std

  # Generate only the appliance for bare-metal deployment, not for VMs.
  appliance_formats: tar.zst

  # Grid'5000 Kadeploy environment parameters
  g5k_postinst_script: g5k-postinstall --net debian-bridged --net hpc --fstab nfs --restrict-user std --disk-aliases
  # Disable cgroup v2 and force cgroup v1 - Bug #12723
  g5k_kernel_params: "systemd.unified_cgroup_hierarchy=false systemd.legacy_systemd_cgroup_controller=true"
  # QEMU options
  qemu_image_size: 16G
  # Visibility override
  g5k_visibility: shared
  g5k_l4t: g5k-l4t-r34.3.1-cti0001-bullseye
  g5k_no_chroot_for_grub: true

bootstrap:
  - "@base"

setup:
  - "@base"
  - add_l4t_overlay:
    - fetch_g5k_l4t_package:
      - write_in: 
        - /etc/apt/sources.list/g5k-l4t.list
        - "deb http://packages.grid5000.fr/deb/g5k-l4t"
      - apt-get_in: update
      - exec_in: apt-get download $${g5l_l4t}
      - exec_in: rm /etc/apt/sources.list/g5k-l4t.list
      - apt-get_in: update
    - unpack_g5k_l4t_files:
      - exec_in: dpkg-deb -X $${g5k_l4t}*.deb g5k-l4t
      - apt-get_in: install lbzip2 qemu-user-static
    - apply_g5k_l4t_overlay:
      - exec_in: g5k-l4t/apply-binaries.sh --root / --target-overlay
    - clean_g5k_l4t:
      - exec_in: rm -rf g5k-l4t
    - rebuild_ld_cache:
      - exec_in: ldconfig
    - disable_nvidia_first_boot:
      - exec_in: rm /etc/nv/nvfirstboot
    - disable_unwanted_l4t_services:
      - exec_in: systemctl disable nvargus-daemon.service
      - exec_in: systemctl disable nv-l4t-usb-device-mode.service
      - exec_in: systemctl disable nv-l4t-bootloader-config.service
      - exec_in: systemctl disable nv_nvsciipc_init.service
    - configure_nvpmodel_all_core:
      - exec_in: dpkg-divert --no-rename /etc/systemd/nvpmodel.sh
      - exec_in: sed -i.distrib -e 's@^\([[:space:]]*/usr/sbin/nvpmodel\) -f /etc/nvpmodel.conf@&\n\1 -m 3@' /etc/systemd/nvpmodel.sh
  - setup_linux_kernel_and_initrd:
    - fix_kernel_image_symlink:
      - exec_in: ln -sfn /boot/Image /vmlinuz
    - uninstall_debian_kernel:
      - apt-get_in: -q=2 remove --purge linux-image-*
    - generate_initramfs:
      - exec_in: mkinitramfs -o /boot/initrd.img $(ls -d /lib/modules/*/kernel | cut -d/ -f4)
  - other_adaptations:
    - truify_ipmitool:
      - exec_in: dpkg-divert --rename /usr/bin/ipmitool
      - exec_in: ln -s /bin/true /usr/bin/ipmitool
    - change_env_name:
      - exec_in: sed -i -e '1s/-std-.\+$/-stdl4t-$${grid5000_environment_export_version}/' /etc/grid5000/release
    - change_motd:
      - exec_in: |
          sed -i \
              -e 's/-std-.\+$/-stdl4t-$${grid5000_environment_export_version}/' \
              -e 's/\(based on .\+\))/\1 + Nvidia L4T layer)/' \
              /etc/motd
  - set_and_clear_var_log

export:
  - "@base"
