#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: Kadeploy3 ramdisk OS (used in the deployment phase) for ARM64
#
# Notes:
# - force use of busybox rather than klibc-utils (which breaks the mount)
#
#==============================================================================
---
extend: kadeploy3-deploy-kernel-bullseye.yaml

global:
  arch: aarch64
  deb_arch: arm64
  deb_kernel_arch: $${deb_arch}
  qemu_arch: x86_64
  arch_specific_packages: kexec-tools grub-efi-arm64 
  deb_kernel: other
  g5k_l4t: g5k-l4t-r34.3.1-cti0001-bullseye

bootstrap:
  - "@base"

setup:
  - "@base"
  - add_l4t_kernel:
    - fetch_g5k_l4t_package:
      - write_in: 
        - /etc/apt/sources.list/g5k-l4t.list
        - "deb http://packages.grid5000.fr/deb/g5k-l4t"
      - apt-get_in: update
      - exec_in: apt-get download $${g5k_l4t}
      - exec_in: rm /etc/apt/sources.list/g5k-l4t.list
      - apt-get_in: update
    - unpack_g5k_l4t_files:
      - exec_in: dpkg-deb -X $${g5k_l4t}*.deb g5k-l4t
    - install_l4t_linux_kernel:
      - exec_in: |
          set -e
          tar -jxf g5k-l4t/kernel/kernel_supplements.tbz2 -C /
          KERNEL_VERSION=$(cd /lib/modules; ls)
          ln -snv /lib/modules/$KERNEL_VERSION /lib/modules/$KERNEL_VERSION-arm64
          cp -av g5k-l4t/kernel/Image /boot/$${kernel_filename}-$KERNEL_VERSION-arm64
          touch /boot/initrd.img-$KERNEL_VERSION-arm64
    - clean_g5k_l4t:
      - exec_in: rm -rf g5k-l4t
export:
  - "@base"
