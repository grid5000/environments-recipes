#==============================================================================
# vim: softtabstop=2 shiftwidth=2 expandtab fenc=utf-8 cc=81 tw=80
#==============================================================================
#
# DESCRIPTION: Ubuntu 24.04 x64 rocm Grid'5000 environment variant to support MI300x GPUs for the vianden cluster (Luxembourg).
#
#==============================================================================
---
extend: ./ubuntu2404-x64-nfs.yaml

global:
  # Grid'5000 environment variant
  g5k_variant: rocm
  # QEMU options
  qemu_memory_size: 16g
  image_size: 80G

bootstrap:
  - "@base"

setup:
  - "@base"
  - rocm_install:
    - prereq_install:
      - apt-get_in: install "linux-headers-$(uname -r)"
      - apt-get_in: install python3-setuptools python3-wheel
    - amdgpu_install:
      - download_file_in:
        - https://repo.radeon.com/amdgpu-install/7.0.1/ubuntu/noble/amdgpu-install_7.0.1.70001-1_all.deb
        - /tmp/amdgpu-install.deb
      - apt-get_in: install /tmp/amdgpu-install.deb
    - amdgpu_install_rocm:
      - exec_in: amdgpu-install -y --usecase=dkms,rocm
    # Grant GPU access to all users (https://rocm.docs.amd.com/projects/install-on-linux/en/docs-7.0.1/install/prerequisites.html#using-udev-rules)
    - amdgpu_udev_rules:
      - download_file_in:
        - https://repo.radeon.com/amdgpu/30.10.1/ubuntu/pool/main/a/amdgpu-insecure-instinct-udev-rules/amdgpu-insecure-instinct-udev-rules_30.10.1.0-2212064.24.04_all.deb
        - /tmp/amdgpu-insecure-instinct-udev-rules.deb
      - apt-get_in: install /tmp/amdgpu-insecure-instinct-udev-rules.deb
export:
  - "@base"
